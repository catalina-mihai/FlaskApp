<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OTP Search</title>

    <!-- Include Select2 CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />

    <!-- Include jQuery (required for Select2) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Include Select2 JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
</head>
<body>
    <form id="searchForm">
        <label for="assetClass">Asset Class:</label>
        <select id="assetClass" name="assetClass" class="select2" onchange="updateInstrumentType(this.value)">
            <option value="">Choose an Asset Class</option>
            {% for option in all_data.assetClass %}
                <option value="{{ option }}">{{ option }}</option>
            {% endfor %}
        </select>

        <label for="instrumentType">Instrument Type:</label>
        <select id="instrumentType" name="instrumentType" class="select2" disabled onchange="updateUseCase(this.value)">
            <option value="">Choose an Instrument Type</option>
        </select>

        <label for="useCase">Use Case:</label>
        <select id="useCase" name="useCase" class="select2" disabled onchange="updateLevel(this.value)">
            <option value="">Choose a Use Case</option>
        </select>

        <label for="level">Level:</label>
        <select id="level" name="level" class="select2" disabled onchange="updateTemplateVersion(this.value)">
            <option value="">Choose a Level</option>
        </select>

        <label for="templateVersion">Template Version:</label>
        <select id="templateVersion" name="templateVersion" class="select2" disabled>
            <option value="">Could be left blank</option>
        </select>

        <button type="button" onclick="performSearch()">Search</button>
    </form>

    <script>
        const allData = {{ all_data | tojson | safe }};
        console.log('All Data:', allData);


        // Initialize select2 dropdowns
        $(document).ready(function() {
            $('.select2').select2();
        });

        function updateInstrumentType(assetClass) {
            let instrumentTypeDropDown = document.querySelector("#instrumentType");
            resetDropdown('instrumentType');
            resetDropdown('useCase');
            resetDropdown('level');
            resetDropdown('templateVersion');

            if (assetClass && allData.instrumentType[assetClass]) {
                allData.instrumentType[assetClass].forEach(type => {
                    instrumentTypeDropDown.innerHTML += `<option value="${type}">${type}</option>`;
                });
                $('#instrumentType').prop('disabled', false).select2();
            }
        }

        function updateUseCase(instrumentType) {
            let useCaseDropDown = document.querySelector("#useCase");
            let assetClass = document.querySelector("#assetClass").value;
            resetDropdown('useCase');
            resetDropdown('level');
            resetDropdown('templateVersion');

            if (assetClass && instrumentType && allData.useCase[assetClass] && allData.useCase[assetClass][instrumentType]) {
                allData.useCase[assetClass][instrumentType].forEach(use => {
                    useCaseDropDown.innerHTML += `<option value="${use}">${use}</option>`;
                });
                $('#useCase').prop('disabled', false).select2();
            }
        }

        function updateLevel(useCase) {
            let levelDropDown = document.querySelector("#level");
            let assetClass = document.querySelector("#assetClass").value;
            let instrumentType = document.querySelector("#instrumentType").value;
            resetDropdown('level');
            resetDropdown('templateVersion');

            if (assetClass && instrumentType && useCase && allData.level[assetClass] &&
                allData.level[assetClass][instrumentType] && allData.level[assetClass][instrumentType][useCase]) {
                allData.level[assetClass][instrumentType][useCase].forEach(level => {
                    levelDropDown.innerHTML += `<option value="${level}">${level}</option>`;
                });
                $('#level').prop('disabled', false).select2();
            }
        }

        function updateTemplateVersion(level) {
            let templateVersionDropDown = document.querySelector("#templateVersion");
            let assetClass = document.querySelector("#assetClass").value;
            let instrumentType = document.querySelector("#instrumentType").value;
            let useCase = document.querySelector("#useCase").value;
            resetDropdown('templateVersion');

            if (assetClass && instrumentType && useCase && level &&
                allData.templateVersion[assetClass] &&
                allData.templateVersion[assetClass][instrumentType] &&
                allData.templateVersion[assetClass][instrumentType][useCase] &&
                allData.templateVersion[assetClass][instrumentType][useCase][level]) {

                allData.templateVersion[assetClass][instrumentType][useCase][level].forEach(version => {
                    templateVersionDropDown.innerHTML += `<option value="${version}">${version}</option>`;
                });
                $('#templateVersion').prop('disabled', false).select2();
            }

            console.log('Selected path:', assetClass, instrumentType, useCase, level);
        }

        function resetDropdown(dropdownId) {
            let dropdown = document.querySelector(`#${dropdownId}`);
            if (dropdownId === 'templateVersion') {
                dropdown.innerHTML = `<option value="">Could be left blank</option>`;
            } else {
                dropdown.innerHTML = `<option value="">Choose a ${dropdownId.charAt(0).toUpperCase() + dropdownId.slice(1)}</option>`;
            }
            $(`#${dropdownId}`).prop('disabled', true).select2();
        }

        function performSearch() {
            console.log('Performing search with selected values');
        }
        $(document).ready(function() {
            function matchCustom(params, data) {
                // If there are no search terms, return all of the data
                if ($.trim(params.term) === '') {
                    return data;
                }

                // `params.term` is the user's search term
                // `data.text` is the option text

                // Check if the search term is anywhere in the option text
                if (data.text.toUpperCase().indexOf(params.term.toUpperCase()) > -1) {
                    return data;
                }

                // Return `null` if the term doesn't match
                return null;
            }

        // Initialize Select2 with the custom matcher
        $('#assetClass').select2({
            matcher: matchCustom
        });
        $('#instrumentType').select2({
            matcher: matchCustom
        });
        $('#useCase').select2({
            matcher: matchCustom
        });
        $('#level').select2({
            matcher: matchCustom
        });
        $('#templateVersion').select2({
            matcher: matchCustom
        });
    });

    </script>
</body>
</html>
