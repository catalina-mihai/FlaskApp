<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OTC Search</title>
    <style>
        /* General Form Styling */
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f7f8;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 800px;
            margin: 20px auto;
            background: #ffffff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            font-weight: bold;
            margin-bottom: 5px;
            display: block;
        }

        select, input[type="text"], input[type="number"], input[type="datetime-local"] {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 14px;
        }

        /* Styling for the search button */
        button {
            padding: 10px 20px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }

        button:hover {
            background-color: #218838;
        }

        /* Styling for the searchable dropdown */
        .searchable-select {
            position: relative;
            margin-top: 10px;
        }

        .searchable-select input {
            padding: 8px;
            width: 100%;
            box-sizing: border-box;
        }

        .dropdown-options {
            position: absolute;
            z-index: 10;
            background: white;
            border: 1px solid #ccc;
            width: 100%;
            max-height: 150px;
            overflow-y: auto;
            display: none;
        }

        .dropdown-options div {
            padding: 8px;
            cursor: pointer;
        }

        .dropdown-options div:hover {
            background-color: #f1f1f1;
        }
    </style>
</head>
<body>
    <div class="container">
        <form id="searchForm">
            <div class="form-group">
                <label for="assetClass">Asset Class:</label>
                <select id="assetClass" name="assetClass" onchange="updateInstrumentType(this.value)">
                    <option value="">Choose an Asset Class</option>
                    {% for option in all_data.assetClass %}
                        <option value="{{ option }}">{{ option }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="instrumentType">Instrument Type:</label>
                <select id="instrumentType" name="instrumentType" disabled onchange="updateUseCase(this.value)">
                    <option value="">Choose an Instrument Type</option>
                </select>
            </div>

            <div class="form-group">
                <label for="useCase">Use Case:</label>
                <select id="useCase" name="useCase" disabled onchange="updateLevel(this.value)">
                    <option value="">Choose a Use Case</option>
                </select>
            </div>

            <div class="form-group">
                <label for="level">Level:</label>
                <select id="level" name="level" disabled onchange="updateTemplateVersion(this.value)">
                    <option value="">Choose a Level</option>
                </select>
            </div>

            <div class="form-group">
                <label for="templateVersion">Template Version:</label>
                <select id="templateVersion" name="templateVersion" disabled>
                    <option value="">Choose a Template Version</option>
                </select>
            </div>

            <button type="button" onclick="performSearch()">Search</button>
                <!-- Find button -->
            <button type="button" onclick="performFind()">Find</button>


        </form>

        <div id="dynamicFields"></div>
        <div id="resultSection"></div>
            <!-- Results will be displayed here -->
        <div id="results"></div>
        
    </div>

    <script>
        const allData = {{ all_data | tojson | safe }};
        

        // Function to update the instrument type dropdown based on the selected asset class
        function updateInstrumentType(assetClass) {
            resetDropdown('instrumentType');
            resetDropdown('useCase');
            resetDropdown('level');
            resetDropdown('templateVersion');
            if (allData.instrumentType[assetClass]) {
                allData.instrumentType[assetClass].forEach(type => {
                    document.querySelector("#instrumentType").innerHTML += `<option value="${type}">${type}</option>`;
                });
                document.querySelector("#instrumentType").disabled = false;
            }
        }

        function updateUseCase(instrumentType) {
            resetDropdown('useCase');
            resetDropdown('level');
            resetDropdown('templateVersion');
            const assetClass = document.querySelector('#assetClass').value;
            if (allData.useCase[assetClass] && allData.useCase[assetClass][instrumentType]) {
                allData.useCase[assetClass][instrumentType].forEach(use => {
                    document.querySelector("#useCase").innerHTML += `<option value="${use}">${use}</option>`;
                });
                document.querySelector("#useCase").disabled = false;
            }
        }

        function updateLevel(useCase) {
            resetDropdown('level');
            resetDropdown('templateVersion');
            const assetClass = document.querySelector('#assetClass').value;
            const instrumentType = document.querySelector('#instrumentType').value;
            if (allData.level[assetClass] && allData.level[assetClass][instrumentType] && allData.level[assetClass][instrumentType][useCase]) {
                allData.level[assetClass][instrumentType][useCase].forEach(level => {
                    document.querySelector("#level").innerHTML += `<option value="${level}">${level}</option>`;
                });
                document.querySelector("#level").disabled = false;
            }
        }

        function updateTemplateVersion(level) {
            resetDropdown('templateVersion');
            const assetClass = document.querySelector('#assetClass').value;
            const instrumentType = document.querySelector('#instrumentType').value;
            const useCase = document.querySelector('#useCase').value;
            if (allData.templateVersion[assetClass] && allData.templateVersion[assetClass][instrumentType] &&
                allData.templateVersion[assetClass][instrumentType][useCase] &&
                allData.templateVersion[assetClass][instrumentType][useCase][level]) {
                allData.templateVersion[assetClass][instrumentType][useCase][level].forEach(version => {
                    document.querySelector("#templateVersion").innerHTML += `<option value="${version}">${version}</option>`;
                });
                document.querySelector("#templateVersion").disabled = false;
            }
        }

        function resetDropdown(dropdownId) {
            let dropdown = document.querySelector(`#${dropdownId}`);
            dropdown.innerHTML = `<option value="">Choose a ${dropdownId.charAt(0).toUpperCase() + dropdownId.slice(1)}</option>`;
            dropdown.disabled = true;
        }

        // Function to perform the search and get dynamic fields
        function performSearch() {
            const formData = {
                assetClass: document.querySelector('#assetClass').value,
                instrumentType: document.querySelector('#instrumentType').value,
                useCase: document.querySelector('#useCase').value,
                level: document.querySelector('#level').value,
                templateVersion: document.querySelector('#templateVersion').value
            };

            fetch('/search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                generateDynamicFields(data);
            })
            .catch(error => {
                console.error('Error fetching attributes:', error);
            });
        }

        // Function to dynamically generate fields based on the API response
        function generateDynamicFields(data) {
            const dynamicFieldsDiv = document.querySelector('#dynamicFields');
            dynamicFieldsDiv.innerHTML = ''; // Clear existing fields

            Object.keys(data.attributes).forEach(attributeKey => {
                const attribute = data.attributes[attributeKey];
                const fieldDiv = document.createElement('div');
                fieldDiv.classList.add('form-group');

                const label = document.createElement('label');
                label.innerHTML = attributeKey;
                fieldDiv.appendChild(label);

                // Generate searchable dropdown for enums
                if (attribute.enumSpan) {
                    createSearchableDropdown(fieldDiv, attributeKey, attribute.enumSpan);
                } 
                else if (attribute.dataType === 'InstrumentTypeEnum') {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.placeholder = `Enter ${attributeKey}`;
                    input.pattern = "^[A-Z]{2}[A-Z0-9]{9}[0-9]$";
                    fieldDiv.appendChild(input);
                }
                // Generate text field
                else if (attribute.dataType === 'string') {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.placeholder = `Enter ${attributeKey}`;
                    fieldDiv.appendChild(input);
                } 
                // Generate integer field
                else if (attribute.dataType === 'int' || attribute.dataType === 'integer') {
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.min = 1;
                    input.value = 1;
                    fieldDiv.appendChild(input);
                }
                // Generate number field
                else if (attribute.dataType === 'number') {
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.step = 0.1;
                    input.min = 0;
                    input.value = 1.0;
                    fieldDiv.appendChild(input);
                }
                // Generate datetime field
                else if (attribute.dataType === 'datetime' || attribute.dataType === 'DateTime') {
                    const input = document.createElement('input');
                    input.type = 'date';
                    fieldDiv.appendChild(input);
                }
                // Generate array fields
                else if (attribute.dataType === 'array') {
                    const input = document.createElement('textarea');
                    input.placeholder = `Enter ${attributeKey} as comma-separated values`;
                    fieldDiv.appendChild(input);
                }
                dynamicFieldsDiv.appendChild(fieldDiv);
            });
        }

        // Function to create a searchable dropdown
        function createSearchableDropdown(container, attributeKey, options) {
            const searchableDiv = document.createElement('div');
            searchableDiv.classList.add('searchable-select');

            const select = document.createElement('select');
            const searchOption = document.createElement('option');
            searchOption.textContent = `Search ${attributeKey}`;
            searchOption.disabled = true;
            searchOption.selected = true;
            select.appendChild(searchOption);

            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                select.appendChild(optionElement);
            });

            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = `Search ${attributeKey}`;
            input.addEventListener('input', () => filterDropdownOptions(input, select, options));

            searchableDiv.appendChild(input);
            searchableDiv.appendChild(select);
            container.appendChild(searchableDiv);
        }

        // Function to filter dropdown options
        function filterDropdownOptions(input, select, options) {
            const filter = input.value.toLowerCase();
            select.innerHTML = ''; // Clear current options

            const searchOption = document.createElement('option');
            searchOption.textContent = `Search ${select.name}`;
            searchOption.disabled = true;
            searchOption.selected = true;
            select.appendChild(searchOption);

            options.forEach(option => {
                if (option.toLowerCase().includes(filter)) {
                    const optionElement = document.createElement('option');
                    optionElement.value = option;
                    optionElement.textContent = option;
                    select.appendChild(optionElement);
                }
            });
        }
       function performFind() {
           const formData = {
               assetClass: document.querySelector('#assetClass').value,
               instrumentType: document.querySelector('#instrumentType').value,
               useCase: document.querySelector('#useCase').value,
               level: document.querySelector('#level').value,
               templateVersion: document.querySelector('#templateVersion').value,
               dynamicFields: gatherDynamicFields() // Collect additional optional fields
           };

           fetch('/find', {
               method: 'POST',
               headers: {
                   'Content-Type': 'application/json'
               },
               body: JSON.stringify(formData)
           })
           .then(response => response.json())
           .then(data => {
               displayResults(data);  // Function to display the results
           })
           .catch(error => {
               console.error('Error fetching instruments:', error);
           });
       }

       // Function to gather dynamic fields data
       function gatherDynamicFields() {
           const dynamicFields = {};
           document.querySelectorAll('#dynamicFields .form-group').forEach(group => {
               const label = group.querySelector('label').innerText;
               const input = group.querySelector('input, textarea, select');
               if (input && input.value) {
                   dynamicFields[label] = input.value;  // Add field if it has a value
               }
           });
           return dynamicFields;
       }

       // Function to display results from the API
       function displayResults(data) {
           const resultsDiv = document.querySelector('#results');
           resultsDiv.innerHTML = '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
       }

    </script>
</body>
</html>
